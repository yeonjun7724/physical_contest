import os
import io
import json
import time
import tempfile
from typing import List, Dict, Any, Optional, Tuple

import cv2
import numpy as np
from PIL import Image
import streamlit as st

# ============================================================
# 1. êµ­ë¯¼ì²´ë ¥100 ì ìˆ˜ í…Œì´ë¸” (ì˜ˆì‹œ ê°’ ìœ ì§€)
# ============================================================

"""
ì‹¤ì œ êµ­ë¯¼ì²´ë ¥100 ê³µì‹ ì ìˆ˜í‘œë¥¼ ê·¸ëŒ€ë¡œ ì˜®ê²¨ì„œ ì•„ë˜ ë”•ì…”ë„ˆë¦¬ì— ë„£ìœ¼ë©´ ë¨.
í˜„ì¬ ìˆ«ìëŠ” "ì˜ˆì‹œ ê°’"ì´ë¯€ë¡œ, ë°˜ë“œì‹œ ê³µì‹ ìë£Œ ë³´ê³  ìˆ˜ì •í•´ì•¼ í•¨.

êµ¬ì¡°:
KFTA_SCORES[exercise_key][gender][age_group] = [
    (ê¸°ì¤€ê°’, ì ìˆ˜),
    (ê¸°ì¤€ê°’, ì ìˆ˜),
    ...
    (0, 0)
]

- exercise_key: "situp", "pushup", "plank", "shuttle_run" ë“±
- gender: "male", "female"
- age_group: "10ëŒ€", "20ëŒ€", "30ëŒ€", "40ëŒ€", "50ëŒ€", "60ëŒ€ ì´ìƒ"
- situp/pushup ë“±: reps(íšŸìˆ˜) ê¸°ì¤€, plank: seconds(ì´ˆ), shuttle_run: ì™•ë³µ íšŸìˆ˜ ë“±
"""

KFTA_SCORES: Dict[str, Dict[str, Dict[str, List[Tuple[float, int]]]]] = {
    # ìœ—ëª¸ì¼ìœ¼í‚¤ê¸° (ì˜ˆì‹œ ê°’)
    "situp": {
        "male": {
            "10ëŒ€": [(55, 100), (50, 90), (45, 80), (40, 70), (35, 60), (30, 50), (25, 40), (20, 30), (15, 20), (10, 10), (0, 0)],
            "20ëŒ€": [(52, 100), (47, 90), (42, 80), (37, 70), (32, 60), (27, 50), (22, 40), (17, 30), (12, 20), (7, 10), (0, 0)],
            "30ëŒ€": [(48, 100), (43, 90), (38, 80), (33, 70), (28, 60), (23, 50), (18, 40), (13, 30), (8, 20), (4, 10), (0, 0)],
            "40ëŒ€": [(44, 100), (39, 90), (34, 80), (29, 70), (24, 60), (19, 50), (14, 40), (9, 30), (5, 20), (2, 10), (0, 0)],
            "50ëŒ€": [(40, 100), (35, 90), (30, 80), (25, 70), (20, 60), (15, 50), (10, 40), (7, 30), (4, 20), (2, 10), (0, 0)],
            "60ëŒ€ ì´ìƒ": [(35, 100), (30, 90), (25, 80), (20, 70), (15, 60), (10, 50), (7, 40), (4, 30), (2, 20), (1, 10), (0, 0)],
        },
        "female": {
            "10ëŒ€": [(50, 100), (45, 90), (40, 80), (35, 70), (30, 60), (25, 50), (20, 40), (15, 30), (10, 20), (5, 10), (0, 0)],
            "20ëŒ€": [(45, 100), (40, 90), (35, 80), (30, 70), (25, 60), (20, 50), (15, 40), (10, 30), (7, 20), (3, 10), (0, 0)],
            "30ëŒ€": [(40, 100), (35, 90), (30, 80), (25, 70), (20, 60), (15, 50), (10, 40), (7, 30), (4, 20), (2, 10), (0, 0)],
            "40ëŒ€": [(36, 100), (31, 90), (26, 80), (21, 70), (16, 60), (11, 50), (8, 40), (5, 30), (3, 20), (1, 10), (0, 0)],
            "50ëŒ€": [(32, 100), (27, 90), (22, 80), (17, 70), (12, 60), (9, 50), (6, 40), (4, 30), (2, 20), (1, 10), (0, 0)],
            "60ëŒ€ ì´ìƒ": [(28, 100), (23, 90), (18, 80), (13, 70), (9, 60), (6, 50), (4, 40), (2, 30), (1, 20), (0, 10), (0, 0)],
        },
    },
    # íŒ”êµ½í˜€í´ê¸° (ì˜ˆì‹œ ê°’)
    "pushup": {
        "male": {
            "10ëŒ€": [(45, 100), (40, 90), (35, 80), (30, 70), (25, 60), (20, 50), (15, 40), (10, 30), (5, 20), (2, 10), (0, 0)],
            "20ëŒ€": [(42, 100), (37, 90), (32, 80), (27, 70), (22, 60), (17, 50), (12, 40), (8, 30), (4, 20), (2, 10), (0, 0)],
            "30ëŒ€": [(38, 100), (33, 90), (28, 80), (23, 70), (18, 60), (13, 50), (9, 40), (5, 30), (3, 20), (1, 10), (0, 0)],
            "40ëŒ€": [(34, 100), (29, 90), (24, 80), (19, 70), (14, 60), (10, 50), (7, 40), (4, 30), (2, 20), (1, 10), (0, 0)],
            "50ëŒ€": [(30, 100), (25, 90), (20, 80), (15, 70), (11, 60), (8, 50), (5, 40), (3, 30), (2, 20), (1, 10), (0, 0)],
            "60ëŒ€ ì´ìƒ": [(26, 100), (21, 90), (16, 80), (12, 70), (9, 60), (6, 50), (4, 40), (2, 30), (1, 20), (0, 10), (0, 0)],
        },
        "female": {
            "10ëŒ€": [(35, 100), (30, 90), (25, 80), (20, 70), (16, 60), (12, 50), (8, 40), (5, 30), (3, 20), (1, 10), (0, 0)],
            "20ëŒ€": [(32, 100), (27, 90), (22, 80), (18, 70), (14, 60), (10, 50), (7, 40), (4, 30), (2, 20), (1, 10), (0, 0)],
            "30ëŒ€": [(28, 100), (23, 90), (18, 80), (14, 70), (11, 60), (8, 50), (5, 40), (3, 30), (2, 20), (1, 10), (0, 0)],
            "40ëŒ€": [(24, 100), (19, 90), (15, 80), (11, 70), (8, 60), (6, 50), (4, 40), (2, 30), (1, 20), (0, 10), (0, 0)],
            "50ëŒ€": [(20, 100), (16, 90), (12, 80), (9, 70), (7, 60), (5, 50), (3, 40), (2, 30), (1, 20), (0, 10), (0, 0)],
            "60ëŒ€ ì´ìƒ": [(16, 100), (13, 90), (10, 80), (7, 70), (5, 60), (3, 50), (2, 40), (1, 30), (0, 20), (0, 10), (0, 0)],
        },
    },
    # í”Œë­í¬ (ì´ˆ ë‹¨ìœ„, ì˜ˆì‹œ)
    "plank": {
        "male": {
            "10ëŒ€": [(180, 100), (150, 90), (120, 80), (90, 70), (60, 60), (45, 50), (30, 40), (20, 30), (10, 20), (5, 10), (0, 0)],
            "20ëŒ€": [(180, 100), (150, 90), (120, 80), (90, 70), (60, 60), (45, 50), (30, 40), (20, 30), (10, 20), (5, 10), (0, 0)],
            "30ëŒ€": [(150, 100), (130, 90), (110, 80), (90, 70), (70, 60), (50, 50), (35, 40), (25, 30), (15, 20), (5, 10), (0, 0)],
            "40ëŒ€": [(140, 100), (120, 90), (100, 80), (80, 70), (60, 60), (45, 50), (30, 40), (20, 30), (10, 20), (5, 10), (0, 0)],
            "50ëŒ€": [(120, 100), (100, 90), (80, 80), (60, 70), (45, 60), (30, 50), (20, 40), (10, 30), (5, 20), (3, 10), (0, 0)],
            "60ëŒ€ ì´ìƒ": [(100, 100), (80, 90), (60, 80), (45, 70), (30, 60), (20, 50), (10, 40), (5, 30), (3, 20), (1, 10), (0, 0)],
        },
        "female": {
            "10ëŒ€": [(150, 100), (130, 90), (110, 80), (90, 70), (70, 60), (50, 50), (35, 40), (25, 30), (15, 20), (5, 10), (0, 0)],
            "20ëŒ€": [(150, 100), (130, 90), (110, 80), (90, 70), (70, 60), (50, 50), (35, 40), (25, 30), (15, 20), (5, 10), (0, 0)],
            "30ëŒ€": [(130, 100), (110, 90), (90, 80), (70, 70), (55, 60), (40, 50), (28, 40), (18, 30), (10, 20), (5, 10), (0, 0)],
            "40ëŒ€": [(110, 100), (90, 90), (75, 80), (60, 70), (45, 60), (30, 50), (20, 40), (12, 30), (7, 20), (3, 10), (0, 0)],
            "50ëŒ€": [(100, 100), (80, 90), (65, 80), (50, 70), (35, 60), (25, 50), (15, 40), (9, 30), (5, 20), (2, 10), (0, 0)],
            "60ëŒ€ ì´ìƒ": [(90, 100), (70, 90), (55, 80), (40, 70), (28, 60), (18, 50), (10, 40), (6, 30), (3, 20), (1, 10), (0, 0)],
        },
    },
    # ì™•ë³µ ì˜¤ë˜ë‹¬ë¦¬ê¸° (ì™•ë³µ ìˆ˜, ì˜ˆì‹œ ê°’)
    "shuttle_run": {
        "male": {
            "10ëŒ€": [(60, 100), (55, 90), (50, 80), (45, 70), (40, 60), (35, 50), (30, 40), (25, 30), (20, 20), (15, 10), (0, 0)],
            "20ëŒ€": [(55, 100), (50, 90), (45, 80), (40, 70), (35, 60), (30, 50), (25, 40), (20, 30), (15, 20), (10, 10), (0, 0)],
            "30ëŒ€": [(50, 100), (45, 90), (40, 80), (35, 70), (30, 60), (25, 50), (20, 40), (15, 30), (10, 20), (5, 10), (0, 0)],
            "40ëŒ€": [(45, 100), (40, 90), (35, 80), (30, 70), (25, 60), (20, 50), (15, 40), (10, 30), (7, 20), (3, 10), (0, 0)],
            "50ëŒ€": [(40, 100), (35, 90), (30, 80), (25, 70), (20, 60), (15, 50), (10, 40), (7, 30), (4, 20), (2, 10), (0, 0)],
            "60ëŒ€ ì´ìƒ": [(35, 100), (30, 90), (25, 80), (20, 70), (15, 60), (10, 50), (7, 40), (4, 30), (2, 20), (1, 10), (0, 0)],
        },
        "female": {
            "10ëŒ€": [(50, 100), (45, 90), (40, 80), (35, 70), (30, 60), (25, 50), (20, 40), (15, 30), (10, 20), (5, 10), (0, 0)],
            "20ëŒ€": [(45, 100), (40, 90), (35, 80), (30, 70), (25, 60), (20, 50), (15, 40), (10, 30), (7, 20), (3, 10), (0, 0)],
            "30ëŒ€": [(40, 100), (35, 90), (30, 80), (25, 70), (20, 60), (15, 50), (10, 40), (7, 30), (4, 20), (2, 10), (0, 0)],
            "40ëŒ€": [(35, 100), (30, 90), (25, 80), (20, 70), (16, 60), (12, 50), (8, 40), (5, 30), (3, 20), (1, 10), (0, 0)],
            "50ëŒ€": [(30, 100), (25, 90), (20, 80), (16, 70), (12, 60), (9, 50), (6, 40), (4, 30), (2, 20), (1, 10), (0, 0)],
            "60ëŒ€ ì´ìƒ": [(25, 100), (20, 90), (16, 80), (12, 70), (9, 60), (6, 50), (4, 40), (2, 30), (1, 20), (0, 10), (0, 0)],
        },
    },
}

# ê³µì‹ í•­ëª©ì´ ì•„ë‹Œ ìš´ë™ì€ "ì—°êµ¬ìš© ì ìˆ˜" ì²˜ë¦¬
NON_KFTA_EXERCISES = {"squat", "burpee", "lunge", "jump", "mixed"}

EXERCISE_KEY_TO_NAME_KR = {
    "situp": "ìœ—ëª¸ì¼ìœ¼í‚¤ê¸°",
    "pushup": "íŒ”êµ½í˜€í´ê¸°",
    "squat": "ìŠ¤ì¿¼íŠ¸",
    "plank": "í”Œë­í¬",
    "burpee": "ë²„í”¼",
    "lunge": "ëŸ°ì§€",
    "jump": "ì œìë¦¬ ì í”„/ìŠ¤í…ë°•ìŠ¤ ì í”„",
    "shuttle_run": "ì™•ë³µ ì˜¤ë˜ë‹¬ë¦¬ê¸°",
    "mixed": "ì¢…í•© ì²´ë ¥ ì¸¡ì •(í˜¼í•© ë™ì‘)",
}


# ============================================================
# 2. ë¹„ë””ì˜¤ â†’ í”„ë ˆì„ ì¶”ì¶œ (OpenCVë§Œ ì‚¬ìš©)
# ============================================================

def extract_frames_from_video_bytes(
    video_bytes: bytes,
    num_frames: int = 4,
    resize_to: Tuple[int, int] = (640, 360),
) -> Tuple[List[np.ndarray], float]:
    """
    mp4 ë°”ì´íŠ¸ â†’ ì„ì‹œíŒŒì¼ â†’ OpenCVë¡œ í”„ë ˆì„ ê· ë“± ì¶”ì¶œ.
    return: (frames(RGB np.ndarray list), duration_sec)
    """
    with tempfile.NamedTemporaryFile(delete=False, suffix=".mp4") as tmp:
        tmp.write(video_bytes)
        tmp_path = tmp.name

    cap = cv2.VideoCapture(tmp_path)
    if not cap.isOpened():
        cap.release()
        os.remove(tmp_path)
        raise RuntimeError("ì˜ìƒ íŒŒì¼ì„ ì—´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")

    frame_count = int(cap.get(cv2.CAP_PROP_FRAME_COUNT))
    fps = cap.get(cv2.CAP_PROP_FPS) or 0.000001
    duration_sec = frame_count / fps if frame_count > 0 else 0.0

    if frame_count <= 0:
        cap.release()
        os.remove(tmp_path)
        raise RuntimeError("ì˜ìƒì—ì„œ í”„ë ˆì„ ì •ë³´ë¥¼ ì½ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")

    # ê· ë“± ê°„ê²© ì¸ë±ìŠ¤
    idxs = np.linspace(0, frame_count - 1, num_frames, dtype=int)

    frames: List[np.ndarray] = []
    for idx in idxs:
        cap.set(cv2.CAP_PROP_POS_FRAMES, int(idx))
        ret, frame = cap.read()
        if not ret:
            continue
        frame = cv2.cvtColor(frame, cv2.COLOR_BGR2RGB)
        frame = cv2.resize(frame, resize_to)
        frames.append(frame)

    cap.release()
    os.remove(tmp_path)

    if not frames:
        raise RuntimeError("í”„ë ˆì„ì„ ì¶”ì¶œí•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.")

    return frames, float(duration_sec)


# ============================================================
# 3. êµ­ë¯¼ì²´ë ¥100 ì ìˆ˜ ê³„ì‚° ë¡œì§ (ìˆ˜ë™ ì…ë ¥ ë²„ì „)
# ============================================================

def lookup_kfta_score(
    exercise_key: str,
    gender: str,
    age_group: str,
    value: float,
) -> Tuple[int, int, str, str]:
    """
    exercise_key, gender('ë‚¨ì„±'/'ì—¬ì„±'), age_group('20ëŒ€' ë“±), ì¸¡ì •ê°’(value)ì„ ê¸°ë°˜ìœ¼ë¡œ
    êµ­ë¯¼ì²´ë ¥100 ì ìˆ˜í‘œì—ì„œ ì ìˆ˜ ì°¾ê¸°.

    return: (score, grade, level_label, remark)
    """
    gender_key = "male" if gender == "ë‚¨ì„±" else "female"

    # ê³µì‹ í•­ëª©ì´ ì•„ë‹Œ ìš´ë™ì€ ì—°êµ¬ìš© ì ìˆ˜ ì²˜ë¦¬
    if exercise_key in NON_KFTA_EXERCISES or exercise_key not in KFTA_SCORES:
        max_ref = 50.0  # 0~50 ë²”ìœ„ë¥¼ 0~100ìœ¼ë¡œ ë‹¨ìˆœ ì •ê·œí™” (ì—°êµ¬ìš©)
        score = int(max(0, min(100, value / max_ref * 100)))

        if score >= 90:
            grade, level = 1, "ë§¤ìš° ìš°ìˆ˜(ì—°êµ¬ìš©)"
        elif score >= 75:
            grade, level = 2, "ìš°ìˆ˜(ì—°êµ¬ìš©)"
        elif score >= 60:
            grade, level = 3, "ë³´í†µ(ì—°êµ¬ìš©)"
        elif score >= 45:
            grade, level = 4, "ì£¼ì˜ í•„ìš”(ì—°êµ¬ìš©)"
        else:
            grade, level = 5, "ê°œì„  í•„ìš”(ì—°êµ¬ìš©)"

        remark = "í•´ë‹¹ ìš´ë™ì€ êµ­ë¯¼ì²´ë ¥100 ê³µì‹ ê¸°ì¤€ì´ ì•„ë‹ˆë¯€ë¡œ ì—°êµ¬ìš© ì ìˆ˜ë¡œ ì‚°ì •í–ˆìŠµë‹ˆë‹¤."
        return score, grade, level, remark

    # ê³µì‹ KFTA í•­ëª©
    table_exc = KFTA_SCORES.get(exercise_key, {})
    table_gender = table_exc.get(gender_key, {})
    thresholds = table_gender.get(age_group, [])

    if not thresholds:
        return 0, 0, "ì ìˆ˜í‘œ ì—†ìŒ", "í•´ë‹¹ ì—°ë ¹/ì„±ë³„ ì¡°í•©ì˜ êµ­ë¯¼ì²´ë ¥100 ê¸°ì¤€í‘œê°€ ë“±ë¡ë˜ì–´ ìˆì§€ ì•ŠìŠµë‹ˆë‹¤."

    score = 0
    for v_min, sc in thresholds:
        if value >= v_min:
            score = sc
            break

    if score >= 90:
        grade, level = 1, "ë§¤ìš° ìš°ìˆ˜"
    elif score >= 75:
        grade, level = 2, "ìš°ìˆ˜"
    elif score >= 60:
        grade, level = 3, "ë³´í†µ"
    elif score >= 45:
        grade, level = 4, "ì£¼ì˜ í•„ìš”"
    else:
        grade, level = 5, "ê°œì„  í•„ìš”"

    remark = "ì ìˆ˜ëŠ” ì˜ˆì‹œ ê°’ì…ë‹ˆë‹¤. ì‹¤ì œ êµ­ë¯¼ì²´ë ¥100 ê³µì‹ ê¸°ì¤€ê°’ìœ¼ë¡œ êµì²´í•´ ì‚¬ìš©í•´ì•¼ í•©ë‹ˆë‹¤."
    return score, grade, level, remark


def compute_score_manual(
    exercise_key: str,
    gender: str,
    age_group: str,
    metric_value: float,
) -> Dict[str, Any]:
    """
    UIì—ì„œ ì„ íƒí•œ ìš´ë™, ì—°ë ¹ëŒ€/ì„±ë³„, ìˆ˜ë™ìœ¼ë¡œ ì…ë ¥í•œ ê¸°ë¡ê°’ì„ ë°”íƒ•ìœ¼ë¡œ ì ìˆ˜ ê³„ì‚°.
    """
    score, grade, level, remark = lookup_kfta_score(
        exercise_key=exercise_key,
        gender=gender,
        age_group=age_group,
        value=metric_value,
    )

    return {
        "exercise_key": exercise_key,
        "exercise_name_kr": EXERCISE_KEY_TO_NAME_KR.get(exercise_key, "ì•Œ ìˆ˜ ì—†ìŒ"),
        "metric_value": metric_value,
        "score": score,
        "grade": grade,
        "level_label": level,
        "remark": remark,
    }


# ============================================================
# 4. Streamlit UI (ì˜ìƒ ë¯¸ë¦¬ë³´ê¸° + ìˆ˜ë™ ê¸°ë¡ ì…ë ¥ + ì ìˆ˜ ê³„ì‚°)
# ============================================================

def main():
    st.set_page_config(page_title="êµ­ë¯¼ì²´ë ¥100 ì ìˆ˜ ë„ìš°ë¯¸ (ì˜ìƒ + ìˆ˜ë™ ì…ë ¥)", layout="wide")

    st.title("ğŸƒâ€â™‚ï¸ êµ­ë¯¼ì²´ë ¥100 ì˜ìƒ + ìˆ˜ë™ ê¸°ë¡ ê¸°ë°˜ ì ìˆ˜ ê³„ì‚° ë°ëª¨")
    st.markdown(
        """
ì—…ë¡œë“œí•œ **ìš´ë™ ì˜ìƒ(mp4)**ì„ ë¯¸ë¦¬ ë³´ê³ ,  
ì§ì ‘ ì¸¡ì •í•œ **ê¸°ë¡(íšŸìˆ˜Â·ì‹œê°„Â·ì™•ë³µ ìˆ˜)**ì„ ì…ë ¥í•˜ë©´  
êµ­ë¯¼ì²´ë ¥100 ì˜ˆì‹œ ê¸°ì¤€ì— ë”°ë¼ ì ìˆ˜ë¥¼ ê³„ì‚°í•´ ì£¼ëŠ” ë„êµ¬ì…ë‹ˆë‹¤.

ìë™ í¬ì¦ˆ ì¸ì‹/AI ë¶„ì„ì€ í˜„ì¬ Streamlit Cloudì˜ Python 3.13 í™˜ê²½ ì œì•½ìœ¼ë¡œ ì¸í•´ ì œì™¸ë˜ì–´ ìˆìŠµë‹ˆë‹¤.
ëŒ€ì‹  ì ìˆ˜ ê³„ì‚° ë¡œì§ê³¼ ì ìˆ˜í‘œ êµ¬ì¡°ëŠ” ê·¸ëŒ€ë¡œ ìœ ì§€ë˜ì–´,  
ê³µì‹ ê¸°ì¤€í‘œ ìˆ˜ì¹˜ë¥¼ ê·¸ëŒ€ë¡œ ë„£ì–´ ì‚¬ìš©í•  ìˆ˜ ìˆëŠ” í˜•íƒœë¡œ ì„¤ê³„ë˜ì–´ ìˆìŠµë‹ˆë‹¤.
"""
    )

    # ì¢Œ/ìš° ë ˆì´ì•„ì›ƒ
    col_left, col_right = st.columns([1, 2])

    with col_left:
        st.subheader("1ï¸âƒ£ ê¸°ë³¸ ì •ë³´ ë° ê¸°ë¡ ì…ë ¥")

        age_group = st.selectbox(
            "ì—°ë ¹ëŒ€",
            ["10ëŒ€", "20ëŒ€", "30ëŒ€", "40ëŒ€", "50ëŒ€", "60ëŒ€ ì´ìƒ"],
            index=1,
            help="êµ­ë¯¼ì²´ë ¥100 ê¸°ì¤€ê³¼ ì—°ë™ë  ì—°ë ¹ëŒ€ì…ë‹ˆë‹¤.",
        )

        gender = st.selectbox(
            "ì„±ë³„",
            ["ë‚¨ì„±", "ì—¬ì„±"],
            index=0,
        )

        # ìš´ë™ ì„ íƒ
        st.markdown("#### ìš´ë™ ì¢…ë¥˜ ì„ íƒ")
        exercise_key = st.selectbox(
            "ìš´ë™ ì¢…ëª©",
            options=list(EXERCISE_KEY_TO_NAME_KR.keys()),
            format_func=lambda k: f"{EXERCISE_KEY_TO_NAME_KR[k]} ({k})",
        )

        # ìš´ë™ë³„ ê¸°ë¡ ë‹¨ìœ„ ì•ˆë‚´
        if exercise_key == "plank":
            metric_label = "ê¸°ë¡ ì…ë ¥ (ë²„í‹´ ì‹œê°„, ì´ˆ ë‹¨ìœ„)"
            metric_help = "ì˜ˆ: 60ì´ˆ ë²„í‹°ë©´ 60 ì…ë ¥"
        elif exercise_key == "shuttle_run":
            metric_label = "ê¸°ë¡ ì…ë ¥ (ì™„ë£Œí•œ ì™•ë³µ íšŸìˆ˜)"
            metric_help = "ì˜ˆ: beep testì—ì„œ 35íšŒ ì™•ë³µ ì™„ë£Œ â†’ 35 ì…ë ¥"
        else:
            metric_label = "ê¸°ë¡ ì…ë ¥ (ì™„ë£Œí•œ ë°˜ë³µ íšŸìˆ˜)"
            metric_help = "ì˜ˆ: 1ë¶„ ë™ì•ˆ 30íšŒ ìˆ˜í–‰ â†’ 30 ì…ë ¥"

        metric_value = st.number_input(
            metric_label,
            min_value=0.0,
            step=1.0,
            format="%.1f",
            help=metric_help,
        )

        st.subheader("2ï¸âƒ£ ì˜ìƒ ì—…ë¡œë“œ (ì„ íƒ)")
        video_file = st.file_uploader(
            "ìš´ë™ ì˜ìƒ ì—…ë¡œë“œ (mp4 í˜•ì‹, ì„ íƒ ì‚¬í•­)",
            type=["mp4"],
            accept_multiple_files=False,
            help="ì˜ìƒì€ ì ìˆ˜ë¥¼ ê³„ì‚°í•˜ëŠ” ë° í•„ìˆ˜ëŠ” ì•„ë‹ˆë©°, ë¯¸ë¦¬ë³´ê¸°ìš©ìœ¼ë¡œ ì‚¬ìš©ë©ë‹ˆë‹¤.",
        )

        analyze_button = st.button("ğŸ§® ì ìˆ˜ ê³„ì‚°í•˜ê¸°", type="primary")

    with col_right:
        st.subheader("3ï¸âƒ£ ì—…ë¡œë“œëœ ì˜ìƒ ë¯¸ë¦¬ë³´ê¸°")
        if video_file is not None:
            st.video(video_file)
        else:
            st.info("ì™¼ìª½ì—ì„œ mp4 íŒŒì¼ì„ ì—…ë¡œë“œí•˜ë©´ ì—¬ê¸°ì—ì„œ ë¯¸ë¦¬ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.")

    st.markdown("---")

    # ë¶„ì„/ê³„ì‚° ì‹¤í–‰
    if analyze_button:
        video_duration = None
        frames: List[np.ndarray] = []

        # ì˜ìƒì´ ìˆì„ ê²½ìš°ì—ë§Œ í”„ë ˆì„ ì¶”ì¶œ
        if video_file is not None:
            try:
                video_bytes = video_file.getvalue()
                with st.spinner("ğŸ ì˜ìƒì—ì„œ ëŒ€í‘œ í”„ë ˆì„ ì¶”ì¶œ ì¤‘..."):
                    frames, video_duration = extract_frames_from_video_bytes(
                        video_bytes,
                        num_frames=4,
                    )
                st.success(f"í”„ë ˆì„ {len(frames)}ì¥ ì¶”ì¶œ ì™„ë£Œ (ì˜ìƒ ê¸¸ì´ ì•½ {video_duration:.1f}ì´ˆ)")
            except Exception as e:
                st.error(f"í”„ë ˆì„ ì¶”ì¶œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤ (ì ìˆ˜ ê³„ì‚°ì—ëŠ” ì˜í–¥ì„ ì£¼ì§€ ì•ŠìŠµë‹ˆë‹¤): {e}")

            if frames:
                st.subheader("4ï¸âƒ£ ì¶”ì¶œëœ ëŒ€í‘œ í”„ë ˆì„")
                cols = st.columns(min(len(frames), 4))
                for i, frame in enumerate(frames):
                    cols[i % len(cols)].image(frame, caption=f"Frame {i+1}", use_container_width=True)
        else:
            st.info("ì˜ìƒ ì—†ì´ë„ ê¸°ë¡ë§Œìœ¼ë¡œ ì ìˆ˜ ê³„ì‚°ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤.")

        # ì ìˆ˜ ê³„ì‚°
        try:
            if metric_value <= 0:
                st.warning("ê¸°ë¡ ê°’ì´ 0 ì´í•˜ì…ë‹ˆë‹¤. ì‹¤ì œ ì¸¡ì •ê°’ì„ ì…ë ¥í•˜ë©´ ë” ì˜ë¯¸ ìˆëŠ” ì ìˆ˜ê°€ ê³„ì‚°ë©ë‹ˆë‹¤.")
            score_result = compute_score_manual(
                exercise_key=exercise_key,
                gender=gender,
                age_group=age_group,
                metric_value=metric_value,
            )
        except Exception as e:
            st.error(f"ì ìˆ˜ ê³„ì‚° ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: {e}")
            st.stop()

        st.markdown("---")
        st.subheader("5ï¸âƒ£ ì ìˆ˜ ê³„ì‚° ê²°ê³¼")

        c1, c2, c3 = st.columns(3)
        with c1:
            st.metric(
                "ìš´ë™ ì¢…ëª©",
                f"{score_result['exercise_name_kr']} ({score_result['exercise_key']})",
            )
        with c2:
            st.metric(
                "ì…ë ¥ ê¸°ë¡",
                f"{score_result['metric_value']:.1f}",
            )
        with c3:
            st.metric("ì ìˆ˜ (0~100)", f"{score_result['score']} ì ")

        c4, c5 = st.columns(2)
        with c4:
            if score_result["grade"] > 0:
                st.metric("ë“±ê¸‰ (1~5)", f"{score_result['grade']} ë“±ê¸‰")
            else:
                st.metric("ë“±ê¸‰ (1~5)", "ê¸°ì¤€ ì—†ìŒ")
        with c5:
            st.metric("í‰ê°€", score_result["level_label"])

        st.caption(score_result["remark"])

        st.markdown("---")
        st.subheader("6ï¸âƒ£ ë””ë²„ê¹…/ì—°êµ¬ìš© JSON ì¶œë ¥")

        result_payload = {
            "input": {
                "age_group": age_group,
                "gender": gender,
                "exercise_key": exercise_key,
                "exercise_name_kr": EXERCISE_KEY_TO_NAME_KR.get(exercise_key),
                "metric_value": metric_value,
                "video_duration_sec": video_duration,
            },
            "score_result": score_result,
        }

        st.json(result_payload)


# ============================================================
# 5. ì‹¤í–‰
# ============================================================

if __name__ == "__main__":
    main()
